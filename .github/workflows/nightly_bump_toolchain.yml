name: Bump lean-toolchain on nightly-testing

on:
  schedule:
    - cron: '45 9/3 * * *'
    # 10:45AM CET/1:45AM PT (and then every 3 hours thereafter),
    # This should be 2 hours and 45 minutes after lean4 starts building the nightly.
    # Mathlib's `nightly-testing` branch is bumped 15 minutes later.

jobs:
  update-toolchain:
    if: github.repository_owner == 'leanprover-community'
    runs-on: ubuntu-latest

    steps:
    - name: Generate app token
      id: app-token
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
      with:
        app-id: ${{ secrets.MATHLIB_NIGHTLY_TESTING_APP_ID }}
        private-key: ${{ secrets.MATHLIB_NIGHTLY_TESTING_PRIVATE_KEY }}
    # The create-github-app-token README states that this token is masked and will not be logged accidentally.

    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        ref: nightly-testing # checkout nightly-testing branch
        token: ${{ steps.app-token.outputs.token }}

    - name: Get latest release tag from leanprover/lean4-nightly
      id: get-latest-release
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}
      run: |
        RELEASE_TAG=$(gh api repos/leanprover/lean4-nightly/releases \
          -f per_page=1 --jq '.[0].tag_name')
        if [ -z "$RELEASE_TAG" ] || [ "$RELEASE_TAG" = "null" ]; then
          echo "::error::Could not determine latest lean4-nightly release"
          exit 1
        fi
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

    - name: Update lean-toolchain file
      run: |
        echo "leanprover/lean4:${RELEASE_TAG}" > lean-toolchain

    - name: Commit and push changes
      run: |
        git config user.name "mathlib-nightly-testing[bot]"
        git config user.email "mathlib-nightly-testing[bot]@users.noreply.github.com"
        git add lean-toolchain
        git commit -m "chore: bump to ${RELEASE_TAG}"
        git push origin nightly-testing
