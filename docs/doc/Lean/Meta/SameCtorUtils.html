<html lang="en"><head><meta charset="UTF-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><link rel="stylesheet" href="../.././style.css"></link><link rel="icon" href="../.././favicon.svg"></link><link rel="mask-icon" href="../.././favicon.svg" color="#000000"></link><link rel="prefetch" href="../.././/declarations/declaration-data.bmp" as="image"></link><title>Lean.Meta.SameCtorUtils</title><script defer="true" src="../.././mathjax-config.js"></script><script defer="true" src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script defer="true" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>const SITE_ROOT="../.././";</script><script>const MODULE_NAME="Lean.Meta.SameCtorUtils";</script><script type="module" src="../.././jump-src.js"></script><script type="module" src="../.././search.js"></script><script type="module" src="../.././expand-nav.js"></script><script type="module" src="../.././how-about.js"></script><script type="module" src="../.././instances.js"></script><script type="module" src="../.././importedBy.js"></script></head><body><input id="nav_toggle" type="checkbox"></input><header><h1><label for="nav_toggle"></label><span>Documentation</span></h1><h2 class="header_filename break_within"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">SameCtorUtils</span></h2><form id="search_form"><input type="text" name="q" autocomplete="off"></input>&#32;<button id="search_button" onclick="javascript: form.action='../.././search.html';">Search</button></form></header><nav class="internal_nav"><p><a href="#top">return to top</a></p><p class="gh_nav_link"><a href="https://github.com/leanprover/lean4/blob/744f98064b056ee27fc8c97f524797c8cc96f436/src/Lean/Meta/SameCtorUtils.lean">source</a></p><div class="imports"><details><summary>Imports</summary><ul><li><a href="../.././Lean/Meta/Basic.html">Lean.Meta.Basic</a></li><li><a href="../.././Lean/Meta/Transform.html">Lean.Meta.Transform</a></li></ul></details><details><summary>Imported by</summary><ul id="imported-by-Lean.Meta.SameCtorUtils" class="imported-by-list"></ul></details></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.occursOrInType"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">occursOrInType</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.occursInCtorTypeMask"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">occursInCtorTypeMask</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.withSharedCtorIndices"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">withSharedCtorIndices</span></a></div></nav><main>
<div class="mod_doc"><p>This module contains utilities for dealing with equalities between constructor applications,
in particular about which fields must be the same a-priori for the equality to type check.</p><p>Users include (or will include) the injectivity theorems, the per-constructor no-confusion
construction and deriving type classes lik <code><a href="../.././Init/Prelude.html#BEq">BEq</a></code>, <code><a href="../.././Init/Prelude.html#DecidableEq">DecidableEq</a></code> or <code><a href="../.././Init/Data/Ord/Basic.html#Ord">Ord</a></code>.</p></div><div class="decl" id="Lean.Meta.occursOrInType"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/744f98064b056ee27fc8c97f524797c8cc96f436/src/Lean/Meta/SameCtorUtils.lean#L22-L50">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/SameCtorUtils.html#Lean.Meta.occursOrInType"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">occursOrInType</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">lctx</span> : <a href="../.././Lean/LocalContext.html#Lean.LocalContext">LocalContext</a>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">e </span><span class="fn">t</span> : <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../.././Init/Prelude.html#Bool">Bool</a></div></div><p>Returns true if <code>e</code> occurs either in <code>t</code>, or in the type of a sub-expression of <code>t</code>.</p><p>Consider the following example:</p><pre><code class="language-lean">inductive Tyₛ : Type (u+1)
| SPi : (T : Type u) -&gt; (T -&gt; Tyₛ) -&gt; Tyₛ

inductive Tmₛ.{u} :  Tyₛ.{u} -&gt; Type (u+1)
| app : Tmₛ (.SPi T A) -&gt; (arg : T) -&gt; Tmₛ (A arg)```
</code></pre><p>When looking for fixed arguments in <code>Tmₛ.app</code>, if we only consider occurrences in the term <code>Tmₛ (A arg)</code>,
<code>T</code> is considered non-fixed despite the fact that <code>A : T -&gt; Tyₛ</code>.
This leads to an ill-typed injectivity theorem signature:</p><pre><code class="language-lean">theorem Tmₛ.app.inj {T : Type u} {A : T → Tyₛ} {a : Tmₛ (Tyₛ.SPi T A)} {arg : T} {T_1 : Type u} {a_1 : Tmₛ (Tyₛ.SPi T_1 A)} :
Tmₛ.app a arg = Tmₛ.app a_1 arg →
  T = T_1 ∧ a ≍ a_1 := fun x =&gt; Tmₛ.noConfusion x fun T_eq A_eq a_eq arg_eq =&gt; <a href="../.././Init/Prelude.html#eq_of_heq">eq_of_heq</a> a_eq
</code></pre><p>Instead of checking the type of every subterm, we only need to check the type of free variables, since free variables introduced in
the constructor may only appear in the type of other free variables introduced after them.</p><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../.././Lean/Meta/SameCtorUtils.html#Lean.Meta.occursOrInType">Lean.Meta.occursOrInType</a> <span class="fn">lctx</span> <span class="fn">e</span> <span class="fn">t</span></span> <a href="../.././Init/Prelude.html#Eq">=</a> <span class="fn"><span class="fn">(<a href="../.././Lean/Util/FindExpr.html#Lean.Expr.find?">Lean.Expr.find?</a> <span class="fn">(<a href="../.././Lean/Meta/SameCtorUtils.html#_private.Lean.Meta.SameCtorUtils.0.Lean.Meta.occursOrInType.go">Lean.Meta.occursOrInType.go✝</a> <span class="fn">lctx</span> <span class="fn">e</span>)</span> <span class="fn">t</span>)</span>.<a href="../.././Init/Data/Option/Basic.html#Option.isSome">isSome</a></span></li></ul></details><details id="instances-for-list-Lean.Meta.occursOrInType" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.occursInCtorTypeMask"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/744f98064b056ee27fc8c97f524797c8cc96f436/src/Lean/Meta/SameCtorUtils.lean#L52-L63">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/SameCtorUtils.html#Lean.Meta.occursInCtorTypeMask"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">occursInCtorTypeMask</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">ctorName</span> : <a href="../.././Init/Prelude.html#Lean.Name">Name</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../.././Lean/Meta/Basic.html#Lean.Meta.MetaM">MetaM</a> <span class="fn">(<a href="../.././Init/Prelude.html#Array">Array</a> <a href="../.././Init/Prelude.html#Bool">Bool</a>)</span></span></div></div><p>Given a constructor, returns a mask of its fields, where <code>true</code> means that this field
occurs in the result type of the constructor.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Meta.occursInCtorTypeMask" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.withSharedCtorIndices"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/744f98064b056ee27fc8c97f524797c8cc96f436/src/Lean/Meta/SameCtorUtils.lean#L65-L98">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/SameCtorUtils.html#Lean.Meta.withSharedCtorIndices"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">withSharedCtorIndices</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{<span class="fn">α</span> : <a href="../.././foundational_types.html">Type</a>}</span></span>
</span><span class="decl_args">
<span class="fn">(<span class="fn">ctor</span> : <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">k</span> : <span class="fn"><span class="fn"><a href="../.././Init/Prelude.html#Array">Array</a> <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a></span> → <span class="fn"><a href="../.././Init/Prelude.html#Array">Array</a> <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a></span> → <span class="fn"><a href="../.././Init/Prelude.html#Array">Array</a> <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a></span> → <span class="fn"><a href="../.././Init/Prelude.html#Array">Array</a> <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a></span> → <span class="fn"><a href="../.././Lean/Meta/Basic.html#Lean.Meta.MetaM">MetaM</a> <span class="fn">α</span></span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../.././Lean/Meta/Basic.html#Lean.Meta.MetaM">MetaM</a> <span class="fn">α</span></span></div></div><p>Given a constructor (applied to the parameters already), brings its fields into scope twice,
but uses the same variable for fields that appear in the result type, so that the resulting
constructor applications have the same type.</p><p>Passes to <code>k</code></p><ul>
<li>the new variables</li>
<li>the indices to the type class</li>
<li>the fields of the first constructor application</li>
<li>the fields of the second constructor application</li>
</ul><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Meta.withSharedCtorIndices" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div></main>
<nav class="nav"><iframe src="../.././navbar.html" class="navframe" frameBorder="0"></iframe></nav></body></html>