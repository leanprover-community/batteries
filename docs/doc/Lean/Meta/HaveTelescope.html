<html lang="en"><head><meta charset="UTF-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><link rel="stylesheet" href="../.././style.css"></link><link rel="icon" href="../.././favicon.svg"></link><link rel="mask-icon" href="../.././favicon.svg" color="#000000"></link><link rel="prefetch" href="../.././/declarations/declaration-data.bmp" as="image"></link><title>Lean.Meta.HaveTelescope</title><script defer="true" src="../.././mathjax-config.js"></script><script defer="true" src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script defer="true" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>const SITE_ROOT="../.././";</script><script>const MODULE_NAME="Lean.Meta.HaveTelescope";</script><script type="module" src="../.././jump-src.js"></script><script type="module" src="../.././search.js"></script><script type="module" src="../.././expand-nav.js"></script><script type="module" src="../.././how-about.js"></script><script type="module" src="../.././instances.js"></script><script type="module" src="../.././importedBy.js"></script></head><body><input id="nav_toggle" type="checkbox"></input><header><h1><label for="nav_toggle"></label><span>Documentation</span></h1><h2 class="header_filename break_within"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">HaveTelescope</span></h2><form id="search_form"><input type="text" name="q" autocomplete="off"></input>&#32;<button id="search_button" onclick="javascript: form.action='../.././search.html';">Search</button></form></header><nav class="internal_nav"><p><a href="#top">return to top</a></p><p class="gh_nav_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean">source</a></p><div class="imports"><details><summary>Imports</summary><ul><li><a href="../.././Init/While.html">Init.While</a></li><li><a href="../.././Lean/Meta/AppBuilder.html">Lean.Meta.AppBuilder</a></li><li><a href="../.././Lean/Meta/Basic.html">Lean.Meta.Basic</a></li><li><a href="../.././Lean/Meta/MonadSimp.html">Lean.Meta.MonadSimp</a></li><li><a href="../.././Lean/Util/CollectFVars.html">Lean.Util.CollectFVars</a></li><li><a href="../.././Lean/Util/CollectLooseBVars.html">Lean.Util.CollectLooseBVars</a></li></ul></details><details><summary>Imported by</summary><ul id="imported-by-Lean.Meta.HaveTelescope" class="imported-by-list"></ul></details></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.HaveInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">HaveInfo</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.instInhabitedHaveInfo.default"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">instInhabitedHaveInfo</span>.<span class="name">default</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.instInhabitedHaveInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">instInhabitedHaveInfo</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.HaveTelescopeInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">HaveTelescopeInfo</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.instInhabitedHaveTelescopeInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">instInhabitedHaveTelescopeInfo</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.instInhabitedHaveTelescopeInfo.default"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">instInhabitedHaveTelescopeInfo</span>.<span class="name">default</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.getHaveTelescopeInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">getHaveTelescopeInfo</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.HaveTelescopeInfo.computeFixedUsed"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">HaveTelescopeInfo</span>.<span class="name">computeFixedUsed</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.ZetaUnusedMode"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">ZetaUnusedMode</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.zetaUnused"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">zetaUnused</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.simpHaveTelescope"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">simpHaveTelescope</span></a></div></nav><main>
<div class="mod_doc"><p>Support for representing <code>HaveTelescope</code>s and simplifying them.
We use this module to implement both <code>Sym.simp</code> and <code>Meta.simp</code> using the <code>MonadSimp</code> adapter.</p></div><div class="decl" id="Lean.Meta.HaveInfo"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L21-L38">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">HaveInfo</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../.././foundational_types.html">Type</a></div></div><p>Information about a single <code>have</code> in a <code>have</code> telescope.
Created by <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.getHaveTelescopeInfo">getHaveTelescopeInfo</a></code>.</p><ul class="structure_fields" id="Lean.Meta.HaveInfo.mk"><li id="Lean.Meta.HaveInfo.typeBackDeps" class="structure_field"><div class="structure_field_info">typeBackDeps : <span class="fn"><a href="../.././Std/Data/HashSet/Basic.html#Std.HashSet">Std.HashSet</a> <a href="../.././Init/Prelude.html#Nat">Nat</a></span></div><div class="structure_field_doc"><p>Previous <code>have</code>s that the type of this <code>have</code> depends on, as indices into <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.haveInfo">HaveTelescopeInfo.haveInfo</a></code>.
Used in <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.computeFixedUsed">computeFixedUsed</a></code> to compute used <code>have</code>s.</p></div></li><li id="Lean.Meta.HaveInfo.valueBackDeps" class="structure_field"><div class="structure_field_info">valueBackDeps : <span class="fn"><a href="../.././Std/Data/HashSet/Basic.html#Std.HashSet">Std.HashSet</a> <a href="../.././Init/Prelude.html#Nat">Nat</a></span></div><div class="structure_field_doc"><p>Previous <code>have</code>s that the value of this <code>have</code> depends on, as indices into <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.haveInfo">HaveTelescopeInfo.haveInfo</a></code>.
Used in <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.computeFixedUsed">computeFixedUsed</a></code> to compute used <code>have</code>s.</p></div></li><li id="Lean.Meta.HaveInfo.decl" class="structure_field"><div class="structure_field_info">decl : <a href="../.././Lean/LocalContext.html#Lean.LocalDecl">LocalDecl</a></div><div class="structure_field_doc"><p>The local decl for the <code>have</code>, so that the local context can be re-entered <code>have</code>-by-<code>have</code>.
N.B. This stores the fvarid for the <code>have</code> as well as cached versions of the value and type
instantiated with the fvars from the telescope.</p></div></li><li id="Lean.Meta.HaveInfo.level" class="structure_field"><div class="structure_field_info">level : <a href="../.././Lean/Level.html#Lean.Level">Level</a></div><div class="structure_field_doc"><p>The level of the type for this <code>have</code>, cached.</p></div></li></ul><details id="instances-for-list-Lean.Meta.HaveInfo" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.instInhabitedHaveInfo.default"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L38-L38">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveInfo.default"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">instInhabitedHaveInfo</span>.<span class="name">default</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveInfo">HaveInfo</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveInfo.default">Lean.Meta.instInhabitedHaveInfo.default</a> <a href="../.././Init/Prelude.html#Eq">=</a>   <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveInfo.mk">{</a> <span class="fn">typeBackDeps</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a>, <span class="fn">valueBackDeps</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a>, <span class="fn">decl</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a>, <span class="fn">level</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a> <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveInfo.mk">}</a></li></ul></details><details id="instances-for-list-Lean.Meta.instInhabitedHaveInfo.default" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.instInhabitedHaveInfo"><div class="instance"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L38-L38">source</a></div><div class="attributes">@[instance_reducible]</div>
<div class="decl_header"><span class="decl_kind">instance</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">instInhabitedHaveInfo</span></a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../.././Init/Prelude.html#Inhabited">Inhabited</a> <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveInfo">HaveInfo</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveInfo">Lean.Meta.instInhabitedHaveInfo</a> <a href="../.././Init/Prelude.html#Eq">=</a> <a href="../.././Init/Prelude.html#Inhabited.mk">{</a> <span class="fn">default</span> := <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveInfo.default">Lean.Meta.instInhabitedHaveInfo.default</a> <a href="../.././Init/Prelude.html#Inhabited.mk">}</a></li></ul></details></div></div><div class="decl" id="Lean.Meta.HaveTelescopeInfo"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L40-L78">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">HaveTelescopeInfo</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../.././foundational_types.html">Type</a></div></div><p>Information about a <code>have</code> telescope.
Created by <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.getHaveTelescopeInfo">getHaveTelescopeInfo</a></code> and used in <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.simpHaveTelescope">simpHaveTelescope</a></code>.</p><p>The data is used to avoid applying <code>Expr.abstract</code> more than once on any given subexpression
when constructing terms and proofs during simplification. Abstraction is linear in the size <code>t</code> of a term,
and so in a depth-<code>n</code> telescope it is <code>O(nt)</code>, quadratic in <code>n</code>, since <code>n ≤ t</code>.
For example, given <code>have x₁ := v₁; ...; have xₙ := vₙ; b</code> and <code>h : b = b'</code>, we need to construct</p><pre><code class="language-lean">have_body_congr (fun x₁ =&gt; ... have_body_congr (fun xₙ =&gt; h)))
</code></pre><p>We apply <code>Expr.abstract</code> to <code>h</code> <em>once</em> and then build the term, rather than
using <code>mkLambdaFVars #[fvarᵢ] pfᵢ</code> at each step.</p><p>As an additional optimization, we save the fvar-instantiated terms calculated by <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.getHaveTelescopeInfo">getHaveTelescopeInfo</a></code>
so that we don't have to compute them again. This is only saving a constant factor.</p><p>It is also used for computing used <code>have</code>s in <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.computeFixedUsed">computeFixedUsed</a></code>.
In <code>have x₁ := v; have x₂ := x₁; ⋯; have xₙ := xₙ₋₁; b</code>, if <code>xₙ</code> is unused in <code>b</code>, then all the
<code>have</code>s are unused. Without a global computation of used <code>have</code>s, the proof term would be quadratic
in the number of <code>have</code>s (with <code>n</code> iterations of <code>simp</code>). Knowing which <code>have</code>s are transitively
unused lets the proof term be linear in size.</p><ul class="structure_fields" id="Lean.Meta.HaveTelescopeInfo.mk"><li id="Lean.Meta.HaveTelescopeInfo.haveInfo" class="structure_field"><div class="structure_field_info">haveInfo : <span class="fn"><a href="../.././Init/Prelude.html#Array">Array</a> <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveInfo">HaveInfo</a></span></div><div class="structure_field_doc"><p>Information about each <code>have</code> in the telescope.</p></div></li><li id="Lean.Meta.HaveTelescopeInfo.bodyDeps" class="structure_field"><div class="structure_field_info">bodyDeps : <span class="fn"><a href="../.././Std/Data/HashSet/Basic.html#Std.HashSet">Std.HashSet</a> <a href="../.././Init/Prelude.html#Nat">Nat</a></span></div><div class="structure_field_doc"><p>The set of <code>have</code>s that the body depends on, as indices into <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.haveInfo">haveInfo</a></code>.
Used in <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.computeFixedUsed">computeFixedUsed</a></code> to compute used <code>have</code>s.</p></div></li><li id="Lean.Meta.HaveTelescopeInfo.bodyTypeDeps" class="structure_field"><div class="structure_field_info">bodyTypeDeps : <span class="fn"><a href="../.././Std/Data/HashSet/Basic.html#Std.HashSet">Std.HashSet</a> <a href="../.././Init/Prelude.html#Nat">Nat</a></span></div><div class="structure_field_doc"><p>The set of <code>have</code>s that the type of the body depends on, as indices into <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.haveInfo">haveInfo</a></code>.
This is the set of fixed <code>have</code>s.</p></div></li><li id="Lean.Meta.HaveTelescopeInfo.body" class="structure_field"><div class="structure_field_info">body : <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a></div><div class="structure_field_doc"><p>A cached version of the telescope body, instantiated with fvars from each <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveInfo.decl">HaveInfo.decl</a></code>.</p></div></li><li id="Lean.Meta.HaveTelescopeInfo.bodyType" class="structure_field"><div class="structure_field_info">bodyType : <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a></div><div class="structure_field_doc"><p>A cached version of the telescope body's type, instantiated with fvars from each <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveInfo.decl">HaveInfo.decl</a></code>.</p></div></li><li id="Lean.Meta.HaveTelescopeInfo.level" class="structure_field"><div class="structure_field_info">level : <a href="../.././Lean/Level.html#Lean.Level">Level</a></div><div class="structure_field_doc"><p>The universe level for the <code>have</code> expression, cached.</p></div></li></ul><details id="instances-for-list-Lean.Meta.HaveTelescopeInfo" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.instInhabitedHaveTelescopeInfo"><div class="instance"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L78-L78">source</a></div><div class="attributes">@[instance_reducible]</div>
<div class="decl_header"><span class="decl_kind">instance</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveTelescopeInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">instInhabitedHaveTelescopeInfo</span></a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../.././Init/Prelude.html#Inhabited">Inhabited</a> <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo">HaveTelescopeInfo</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveTelescopeInfo">Lean.Meta.instInhabitedHaveTelescopeInfo</a> <a href="../.././Init/Prelude.html#Eq">=</a> <a href="../.././Init/Prelude.html#Inhabited.mk">{</a> <span class="fn">default</span> := <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveTelescopeInfo.default">Lean.Meta.instInhabitedHaveTelescopeInfo.default</a> <a href="../.././Init/Prelude.html#Inhabited.mk">}</a></li></ul></details></div></div><div class="decl" id="Lean.Meta.instInhabitedHaveTelescopeInfo.default"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L78-L78">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveTelescopeInfo.default"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">instInhabitedHaveTelescopeInfo</span>.<span class="name">default</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo">HaveTelescopeInfo</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.instInhabitedHaveTelescopeInfo.default">Lean.Meta.instInhabitedHaveTelescopeInfo.default</a> <a href="../.././Init/Prelude.html#Eq">=</a>   <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.mk">{</a> <span class="fn">haveInfo</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a>, <span class="fn">bodyDeps</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a>, <span class="fn">bodyTypeDeps</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a>, <span class="fn">body</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a>, <span class="fn">bodyType</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a>,
    <span class="fn">level</span> := <a href="../.././Init/Prelude.html#Inhabited.default">default</a> <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.mk">}</a></li></ul></details><details id="instances-for-list-Lean.Meta.instInhabitedHaveTelescopeInfo.default" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.getHaveTelescopeInfo"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L80-L126">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.getHaveTelescopeInfo"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">getHaveTelescopeInfo</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">e</span> : <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../.././Lean/Meta/Basic.html#Lean.Meta.MetaM">MetaM</a> <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo">HaveTelescopeInfo</a></span></div></div><p>Efficiently collect dependency information for a <code>have</code> telescope.
This is part of a scheme to avoid quadratic overhead from the locally nameless discipline
(see <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo">HaveTelescopeInfo</a></code> and <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.simpHaveTelescope">simpHaveTelescope</a></code>).</p><p>The expression <code>e</code> must not have loose bvars.</p><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.getHaveTelescopeInfo">Lean.Meta.getHaveTelescopeInfo</a> <span class="fn">e</span></span> <a href="../.././Init/Prelude.html#Eq">=</a> <span class="fn">do
  let <span class="fn">__do_lift</span> ← <a href="../.././Lean/LocalContext.html#Lean.MonadLCtx.getLCtx">Lean.getLCtx</a>
  <span class="fn"><a href="../.././Lean/Meta/HaveTelescope.html#_private.Lean.Meta.HaveTelescope.0.Lean.Meta.getHaveTelescopeInfo.collect">Lean.Meta.getHaveTelescopeInfo.collect✝</a> <span class="fn">e</span> <span class="fn">0</span> <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.mk">{</a> <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.mk">}</a> <span class="fn">__do_lift</span> <a href="../.././Init/Prelude.html#List.toArray">#[</a><a href="../.././Init/Prelude.html#List.toArray">]</a></span></span></li></ul></details><details id="instances-for-list-Lean.Meta.getHaveTelescopeInfo" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.HaveTelescopeInfo.computeFixedUsed"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L128-L156">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo.computeFixedUsed"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">HaveTelescopeInfo</span>.<span class="name">computeFixedUsed</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">info</span> : <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo">HaveTelescopeInfo</a>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">keepUnused</span> : <a href="../.././Init/Prelude.html#Bool">Bool</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../.././Lean/Meta/Basic.html#Lean.Meta.MetaM">MetaM</a> (<span class="fn"><a href="../.././Init/Prelude.html#Array">Array</a> <a href="../.././Init/Prelude.html#Bool">Bool</a></span> <a href="../.././Init/Prelude.html#Prod">×</a> <span class="fn"><a href="../.././Init/Prelude.html#Array">Array</a> <a href="../.././Init/Prelude.html#Bool">Bool</a></span>)</span></div></div><p>Computes which <code>have</code>s in the telescope are fixed and which are unused.
The length of the unused array may be less than the number of <code>have</code>s: use <code>unused.getD i true</code>.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Meta.HaveTelescopeInfo.computeFixedUsed" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.ZetaUnusedMode"><div class="inductive"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L334-L341">source</a></div><div class="decl_header"><span class="decl_kind">inductive</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.ZetaUnusedMode"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">ZetaUnusedMode</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../.././foundational_types.html">Type</a></div></div><p>Configuration for specifying how unused let-declarations are eliminated.</p><ul class="constructors"><li class="constructor" id="Lean.Meta.ZetaUnusedMode.no">no : <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.ZetaUnusedMode">ZetaUnusedMode</a><div class="inductive_ctor_doc"><p>Do not eliminate unused <code>let</code>-declarations.</p></div></li><li class="constructor" id="Lean.Meta.ZetaUnusedMode.singlePass">singlePass : <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.ZetaUnusedMode">ZetaUnusedMode</a><div class="inductive_ctor_doc"><p>Simplify and eliminate unused <code>let</code>-declarations in a single pass.</p></div></li><li class="constructor" id="Lean.Meta.ZetaUnusedMode.twoPasses">twoPasses : <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.ZetaUnusedMode">ZetaUnusedMode</a><div class="inductive_ctor_doc"><p>Simplify and then eliminate unused <code>let</code>-declarations.</p></div></li></ul><details id="instances-for-list-Lean.Meta.ZetaUnusedMode" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.zetaUnused"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L343-L361">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.zetaUnused"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">zetaUnused</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">e</span> : <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../.././Lean/Meta/Basic.html#Lean.Meta.MetaM">MetaM</a> <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a></span></div></div><p>Remove unused-let declarations.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Meta.zetaUnused" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.simpHaveTelescope"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/HaveTelescope.lean#L399-L459">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.simpHaveTelescope"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">simpHaveTelescope</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{<span class="fn">m</span> : <span class="fn"><a href="../.././foundational_types.html">Type</a> → <a href="../.././foundational_types.html">Type</a></span>}</span></span>
</span><span class="impl_arg"><span class="decl_args">
<span class="fn">[<span class="fn"><a href="../.././Init/Prelude.html#Monad">Monad</a> <span class="fn">m</span></span>]</span></span>
</span><span class="impl_arg"><span class="decl_args">
<span class="fn">[<span class="fn"><a href="../.././Init/Prelude.html#MonadLiftT">MonadLiftT</a> <a href="../.././Lean/Meta/Basic.html#Lean.Meta.MetaM">MetaM</a> <span class="fn">m</span></span>]</span></span>
</span><span class="impl_arg"><span class="decl_args">
<span class="fn">[<span class="fn"><a href="../.././Init/Control/Basic.html#MonadControlT">MonadControlT</a> <a href="../.././Lean/Meta/Basic.html#Lean.Meta.MetaM">MetaM</a> <span class="fn">m</span></span>]</span></span>
</span><span class="impl_arg"><span class="decl_args">
<span class="fn">[<span class="fn"><a href="../.././Lean/Meta/MonadSimp.html#Lean.Meta.MonadSimp">MonadSimp</a> <span class="fn">m</span></span>]</span></span>
</span><span class="decl_args">
<span class="fn">(<span class="fn">e</span> : <a href="../.././Lean/Expr.html#Lean.Expr">Expr</a>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">zetaUnusedMode</span> : <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.ZetaUnusedMode">ZetaUnusedMode</a> := <a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.ZetaUnusedMode.twoPasses">ZetaUnusedMode.twoPasses</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><span class="fn">m</span> <a href="../.././Lean/Meta/MonadSimp.html#Lean.Meta.MonadSimp.Result">MonadSimp.Result</a></span></div></div><p>Routine for simplifying <code>have</code> telescopes. Used by <code>simpLet</code>.
This is optimized to be able to handle deep <code>have</code> telescopes while avoiding quadratic complexity
arising from the locally nameless expression representations.</p><h2 id="Overview" class="markdown-heading">Overview <a class="hover-link" href="#Overview">#</a></h2><p>Consider a <code>have</code> telescope:</p><pre><code>have x₁ : T₁ := v₁; ...; have xₙ : Tₙ := vₙ; b
</code></pre><p>We say <code>xᵢ</code> is <em>fixed</em> if it appears in the type of <code>b</code>.
If <code>xᵢ</code> is fixed, then it can only be rewritten using definitional equalities.
Otherwise, we can freely rewrite the value using a propositional equality <code>vᵢ = vᵢ'</code>.
The body <code>b</code> can always be freely rewritten using a propositional equality <code>b = b'</code>.
(All the mentioned equalities must be type correct with respect to the obvious local contexts.)</p><p>If <code>xᵢ</code> neither appears in <code>b</code> nor any <code>Tⱼ</code> nor any <code>vⱼ</code>, then its <code>have</code> is <em>unused</em>.
Unused <code>have</code>s can be eliminated, which we do if <code>cfg.<a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.zetaUnused">zetaUnused</a></code> is true.
We clear <code>have</code>s from the end, to be able to transitively clear chains of unused <code>have</code>s.
This is why we honor <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.zetaUnused">zetaUnused</a></code> here even though <code>reduceStep</code> is also responsible for it;
<code>reduceStep</code> can only eliminate unused <code>have</code>s at the start of a telescope.
Eliminating all transitively unused <code>have</code>s at once like this also avoids quadratic complexity.</p><p>If <code>debug.simp.check.have</code> is enabled then we typecheck the resulting expression and proof.</p><h2 id="Proof-generation" class="markdown-heading">Proof generation <a class="hover-link" href="#Proof-generation">#</a></h2><p>There are two main complications with generating proofs.</p><ol><li>We work almost exclusively with expressions with loose bound variables,
to avoid overhead from instantiating and abstracting free variables,
which can lead to complexity quadratic in the telescope length.
(See <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.HaveTelescopeInfo">HaveTelescopeInfo</a></code>.)</li><li>We want to avoid triggering zeta reductions in the kernel.</li></ol><p>Regarding this second point, the issue is that we cannot organize the proof using congruence theorems
in the obvious way. For example, given</p><pre><code>theorem have_congr {α : Sort u} {β : Sort v} {a a' : α} {f f' : α → β}
    (h₁ : a = a') (h₂ : ∀ x, f x = f' x) :
    (have x := a; f x) = (have x := a'; f' x)
</code></pre><p>the kernel sees that the type of <code>have_congr (fun x =&gt; b) (fun x =&gt; b') h₁ h₂</code>
is <code>(have x := a; (fun x =&gt; b) x) = (have x := a'; (fun x =&gt; b') x)</code>,
since when instantiating values it does not beta reduce at the same time.
Hence, when <code>is_def_eq</code> is applied to the LHS and <code>have x := a; b</code> for example,
it will do <code>whnf_core</code> to both sides.</p><p>Instead, we use the form <code>(fun x =&gt; b) a = (fun x =&gt; b') a'</code> in the proofs,
which we can reliably match up without triggering beta reductions in the kernel.
The zeta/beta reductions are then limited to the type hint for the entire telescope,
when we convert this back into <code>have</code> form.
In the base case, we include an optimization to avoid unnecessary zeta/beta reductions,
by detecting a <code><a href="../.././Lean/Meta/HaveTelescope.html#Lean.Meta.simpHaveTelescope">simpHaveTelescope</a></code> proofs and removing the type hint.</p><details id="instances-for-list-Lean.Meta.simpHaveTelescope" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div></main>
<nav class="nav"><iframe src="../.././navbar.html" class="navframe" frameBorder="0"></iframe></nav></body></html>