<html lang="en"><head><meta charset="UTF-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><link rel="stylesheet" href="../../../../.././style.css"></link><link rel="icon" href="../../../../.././favicon.svg"></link><link rel="mask-icon" href="../../../../.././favicon.svg" color="#000000"></link><link rel="prefetch" href="../../../../.././/declarations/declaration-data.bmp" as="image"></link><title>Lean.Meta.Tactic.Grind.Arith.Propagate</title><script defer="true" src="../../../../.././mathjax-config.js"></script><script defer="true" src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script defer="true" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>const SITE_ROOT="../../../../.././";</script><script>const MODULE_NAME="Lean.Meta.Tactic.Grind.Arith.Propagate";</script><script type="module" src="../../../../.././jump-src.js"></script><script type="module" src="../../../../.././search.js"></script><script type="module" src="../../../../.././expand-nav.js"></script><script type="module" src="../../../../.././how-about.js"></script><script type="module" src="../../../../.././instances.js"></script><script type="module" src="../../../../.././importedBy.js"></script></head><body><input id="nav_toggle" type="checkbox"></input><header><h1><label for="nav_toggle"></label><span>Documentation</span></h1><h2 class="header_filename break_within"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Tactic</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">Propagate</span></h2><form id="search_form"><input type="text" name="q" autocomplete="off"></input>&#32;<button id="search_button" onclick="javascript: form.action='../../../../.././search.html';">Search</button></form></header><nav class="internal_nav"><p><a href="#top">return to top</a></p><p class="gh_nav_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/Tactic/Grind/Arith/Propagate.lean">source</a></p><div class="imports"><details><summary>Imports</summary><ul><li><a href="../../../../.././Init/Grind.html">Init.Grind</a></li><li><a href="../../../../.././Lean/Meta/Tactic/Grind/PropagatorAttr.html">Lean.Meta.Tactic.Grind.PropagatorAttr</a></li><li><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/CommRing/NonCommRingM.html">Lean.Meta.Tactic.Grind.Arith.CommRing.NonCommRingM</a></li><li><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/CommRing/NonCommSemiringM.html">Lean.Meta.Tactic.Grind.Arith.CommRing.NonCommSemiringM</a></li><li><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/CommRing/RingId.html">Lean.Meta.Tactic.Grind.Arith.CommRing.RingId</a></li></ul></details><details><summary>Imported by</summary><ul id="imported-by-Lean.Meta.Tactic.Grind.Arith.Propagate" class="imported-by-list"></ul></details></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.Grind.Arith.propagateNatBinOp"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatBinOp</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.Grind.Arith.propagateNatAnd"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatAnd</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.Grind.Arith.propagateNatOr"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatOr</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.Grind.Arith.propagateNatXOr"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatXOr</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.Grind.Arith.propagateNatShiftLeft"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatShiftLeft</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.Grind.Arith.propagateNatShiftRight"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatShiftRight</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Meta.Grind.Arith.propagateMul"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateMul</span></a></div></nav><main>
<div class="mod_doc"><p>This file defines propagators for <code><a href="../../../../.././Init/Prelude.html#Nat">Nat</a></code> operators that have simprocs associated with them, but do not
have support in satellite solvers. The goal is to workaround a nasty interaction between
E-matching and normalization. Consider the following example:</p><pre><code>@[grind] def mask := 15

@[grind =] theorem foo (x : Nat) : x &amp;&amp;&amp; 15 = x % 16 := by sorry

example (x : Nat) : 3 &amp;&amp;&amp; mask = 3 := by
  grind only [foo, mask]
</code></pre><p>This is a very simple version of issue #11498.
The e-graph contains <code>3 &amp;&amp;&amp; mask</code>. E-matching finds that <code>3 &amp;&amp;&amp; mask</code> matches pattern <code>x &amp;&amp;&amp; 15</code>
modulo the equality <code>mask = 15</code>, binding <code>x := 3</code>.
Thus is produces the theorem instance <code>3 &amp;&amp;&amp; 15 = 3 % 16</code>, which simplifies to <code><a href="../../../../.././Init/Prelude.html#True">True</a></code> using the
builtin simprocs for <code>&amp;&amp;&amp;</code> and <code>%</code>. So, nothing is learned.
<strong>Tension</strong>: The invariant &quot;all terms in e-graph are normalized&quot; conflicts with congruence needing
the intermediate term <code>3 &amp;&amp;&amp; 15</code> to make the connection.
This is yet another example that shows how tricky is to combine e-matching with a normalizer.
It is yet another reason for not letting users to extend the normalizer.
If we do, we should be able to mark which ones should be used not normalize theorem instances.
The following propagator ensure that <code>3 &amp;&amp;&amp; mask</code> is merged with the equivalence class <code>3</code> if
<code>mask = 15</code>.</p></div><div class="decl" id="Lean.Meta.Grind.Arith.propagateNatBinOp"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/Tactic/Grind/Arith/Propagate.lean#L42-L57">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatBinOp"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatBinOp</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">declName </span><span class="fn">congrThmName</span> : <a href="../../../../.././Init/Prelude.html#Lean.Name">Name</a>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">op</span> : <span class="fn"><a href="../../../../.././Init/Prelude.html#Nat">Nat</a> → <a href="../../../../.././Init/Prelude.html#Nat">Nat</a> → <a href="../../../../.././Init/Prelude.html#Nat">Nat</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">e</span> : <a href="../../../../.././Lean/Expr.html#Lean.Expr">Expr</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../../../.././Lean/Meta/Tactic/Grind/Types.html#Lean.Meta.Grind.GoalM">GoalM</a> <a href="../../../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Meta.Grind.Arith.propagateNatBinOp" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.Grind.Arith.propagateNatAnd"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/Tactic/Grind/Arith/Propagate.lean#L59-L59">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatAnd"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatAnd</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../../../.././Lean/Meta/Tactic/Grind/Types.html#Lean.Meta.Grind.Propagator">Propagator</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatAnd">Lean.Meta.Grind.Arith.propagateNatAnd</a> <a href="../../../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatBinOp">Lean.Meta.Grind.Arith.propagateNatBinOp</a> <span class="fn">`HAnd.hAnd</span> <span class="fn">`Lean.Grind.Nat.and_congr</span> <span class="fn">fun (<span class="fn">x1</span> <span class="fn">x2</span> : <a href="../../../../.././Init/Prelude.html#Nat">Nat</a>) =&gt; <span class="fn">x1</span> <a href="../../../../.././Init/Prelude.html#HAnd.hAnd">&amp;&amp;&amp;</a> <span class="fn">x2</span></span></span></li></ul></details><details id="instances-for-list-Lean.Meta.Grind.Arith.propagateNatAnd" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.Grind.Arith.propagateNatOr"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/Tactic/Grind/Arith/Propagate.lean#L60-L60">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatOr"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatOr</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../../../.././Lean/Meta/Tactic/Grind/Types.html#Lean.Meta.Grind.Propagator">Propagator</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatOr">Lean.Meta.Grind.Arith.propagateNatOr</a> <a href="../../../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatBinOp">Lean.Meta.Grind.Arith.propagateNatBinOp</a> <span class="fn">`HOr.hOr</span> <span class="fn">`Lean.Grind.Nat.or_congr</span> <span class="fn">fun (<span class="fn">x1</span> <span class="fn">x2</span> : <a href="../../../../.././Init/Prelude.html#Nat">Nat</a>) =&gt; <span class="fn">x1</span> <a href="../../../../.././Init/Prelude.html#HOr.hOr">|||</a> <span class="fn">x2</span></span></span></li></ul></details><details id="instances-for-list-Lean.Meta.Grind.Arith.propagateNatOr" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.Grind.Arith.propagateNatXOr"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/Tactic/Grind/Arith/Propagate.lean#L61-L61">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatXOr"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatXOr</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../../../.././Lean/Meta/Tactic/Grind/Types.html#Lean.Meta.Grind.Propagator">Propagator</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatXOr">Lean.Meta.Grind.Arith.propagateNatXOr</a> <a href="../../../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatBinOp">Lean.Meta.Grind.Arith.propagateNatBinOp</a> <span class="fn">`HXor.hXor</span> <span class="fn">`Lean.Grind.Nat.xor_congr</span> <span class="fn">fun (<span class="fn">x1</span> <span class="fn">x2</span> : <a href="../../../../.././Init/Prelude.html#Nat">Nat</a>) =&gt; <span class="fn">x1</span> <a href="../../../../.././Init/Prelude.html#HXor.hXor">^^^</a> <span class="fn">x2</span></span></span></li></ul></details><details id="instances-for-list-Lean.Meta.Grind.Arith.propagateNatXOr" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.Grind.Arith.propagateNatShiftLeft"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/Tactic/Grind/Arith/Propagate.lean#L62-L63">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatShiftLeft"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatShiftLeft</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../../../.././Lean/Meta/Tactic/Grind/Types.html#Lean.Meta.Grind.Propagator">Propagator</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatShiftLeft">Lean.Meta.Grind.Arith.propagateNatShiftLeft</a> <a href="../../../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatBinOp">Lean.Meta.Grind.Arith.propagateNatBinOp</a> <span class="fn">`HShiftLeft.hShiftLeft</span> <span class="fn">`Lean.Grind.Nat.shiftLeft_congr</span> <span class="fn">fun (<span class="fn">x1</span> <span class="fn">x2</span> : <a href="../../../../.././Init/Prelude.html#Nat">Nat</a>) =&gt;
    <span class="fn">x1</span> <a href="../../../../.././Init/Prelude.html#HShiftLeft.hShiftLeft">&lt;&lt;&lt;</a> <span class="fn">x2</span></span></span></li></ul></details><details id="instances-for-list-Lean.Meta.Grind.Arith.propagateNatShiftLeft" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.Grind.Arith.propagateNatShiftRight"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/Tactic/Grind/Arith/Propagate.lean#L64-L65">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatShiftRight"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateNatShiftRight</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../../../.././Lean/Meta/Tactic/Grind/Types.html#Lean.Meta.Grind.Propagator">Propagator</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatShiftRight">Lean.Meta.Grind.Arith.propagateNatShiftRight</a> <a href="../../../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateNatBinOp">Lean.Meta.Grind.Arith.propagateNatBinOp</a> <span class="fn">`HShiftRight.hShiftRight</span> <span class="fn">`Lean.Grind.Nat.shiftRight_congr</span> <span class="fn">fun (<span class="fn">x1</span> <span class="fn">x2</span> : <a href="../../../../.././Init/Prelude.html#Nat">Nat</a>) =&gt;
    <span class="fn">x1</span> <a href="../../../../.././Init/Prelude.html#HShiftRight.hShiftRight">&gt;&gt;&gt;</a> <span class="fn">x2</span></span></span></li></ul></details><details id="instances-for-list-Lean.Meta.Grind.Arith.propagateNatShiftRight" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Meta.Grind.Arith.propagateMul"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Meta/Tactic/Grind/Arith/Propagate.lean#L102-L129">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../../../.././Lean/Meta/Tactic/Grind/Arith/Propagate.html#Lean.Meta.Grind.Arith.propagateMul"><span class="name">Lean</span>.<span class="name">Meta</span>.<span class="name">Grind</span>.<span class="name">Arith</span>.<span class="name">propagateMul</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../../../.././Lean/Meta/Tactic/Grind/Types.html#Lean.Meta.Grind.Propagator">Propagator</a></div></div><p>Propagator for the <code>0*a</code>, <code>1*a</code>, <code>a*0</code>, <code>a*1</code> for semirings that do not have good support in
<code>grind ring</code>. We need this propagator because have normalization rules for them, and users
were surprised when using <code>grind [zero_mul]</code> did not have any effect. In this scenario,
<code>grind</code> was correctly instantiating <code>zero_mul : 0*a = 0</code>, but the normalizer reduces the
instance to <code><a href="../../../../.././Init/Prelude.html#True">True</a></code>.</p><p>Alternative approach: We improve the support for equality reasoning for non-commutative rings
and semirings in <code>grind ring</code>. For example, we could just replace equalities and keep renormalizing.
If we implement this feature, this propagator can be deleted.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Meta.Grind.Arith.propagateMul" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div></main>
<nav class="nav"><iframe src="../../../../.././navbar.html" class="navframe" frameBorder="0"></iframe></nav></body></html>