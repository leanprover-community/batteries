<html lang="en"><head><meta charset="UTF-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><link rel="stylesheet" href="../../.././style.css"></link><link rel="icon" href="../../.././favicon.svg"></link><link rel="mask-icon" href="../../.././favicon.svg" color="#000000"></link><link rel="prefetch" href="../../.././/declarations/declaration-data.bmp" as="image"></link><title>Lean.Compiler.LCNF.InferBorrow</title><script defer="true" src="../../.././mathjax-config.js"></script><script defer="true" src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script defer="true" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>const SITE_ROOT="../../.././";</script><script>const MODULE_NAME="Lean.Compiler.LCNF.InferBorrow";</script><script type="module" src="../../.././jump-src.js"></script><script type="module" src="../../.././search.js"></script><script type="module" src="../../.././expand-nav.js"></script><script type="module" src="../../.././how-about.js"></script><script type="module" src="../../.././instances.js"></script><script type="module" src="../../.././importedBy.js"></script></head><body><input id="nav_toggle" type="checkbox"></input><header><h1><label for="nav_toggle"></label><span>Documentation</span></h1><h2 class="header_filename break_within"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">InferBorrow</span></h2><form id="search_form"><input type="text" name="q" autocomplete="off"></input>&#32;<button id="search_button" onclick="javascript: form.action='../../.././search.html';">Search</button></form></header><nav class="internal_nav"><p><a href="#top">return to top</a></p><p class="gh_nav_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/InferBorrow.lean">source</a></p><div class="imports"><details><summary>Imports</summary><ul><li><a href="../../.././Lean/Compiler/ExportAttr.html">Lean.Compiler.ExportAttr</a></li><li><a href="../../.././Lean/Compiler/LCNF/CompilerM.html">Lean.Compiler.LCNF.CompilerM</a></li><li><a href="../../.././Lean/Compiler/LCNF/FVarUtil.html">Lean.Compiler.LCNF.FVarUtil</a></li><li><a href="../../.././Lean/Compiler/LCNF/MonadScope.html">Lean.Compiler.LCNF.MonadScope</a></li><li><a href="../../.././Lean/Compiler/LCNF/PassManager.html">Lean.Compiler.LCNF.PassManager</a></li><li><a href="../../.././Lean/Compiler/LCNF/PhaseExt.html">Lean.Compiler.LCNF.PhaseExt</a></li><li><a href="../../.././Std/Data/Iterators/Combinators/Zip.html">Std.Data.Iterators.Combinators.Zip</a></li><li><a href="../../.././Std/Data/Iterators/Producers/Array.html">Std.Data.Iterators.Producers.Array</a></li></ul></details><details><summary>Imported by</summary><ul id="imported-by-Lean.Compiler.LCNF.InferBorrow" class="imported-by-list"></ul></details></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.inferBorrow"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">inferBorrow</span></a></div></nav><main>
<div class="mod_doc"><p>This pass is responsible for inferring borrow annotations to the parameters of functions and join
points. When a parameter is marked as borrowed, the caller can be sure that the function will not
decrement the reference count of the parameter. Thus, if the value is still used after the call, the
caller does not need to <code>inc</code> it before calling in order to ensure that it stays alive.</p><p>The inference is done with a data flow analysis which initially assumes all arguments are passed as
borrowed and subsequently refines this by marking parameters as owned as required and propagating
the information throughout the program. The analysis has two reasons for marking a parameter as owned.
Some parameters need to be owned for correctness, while others are heuristically marked as owned to
reduce reference counting pressure inside of the function.</p><p>The correctness ones are the following:</p><ul><li>We preserve tail calls to recursive functions and join points by ensuring we never have to insert
a <code>dec</code> after a tail call. This is done by marking parameters of tail-called functions/jps as owned
if a respective argument at a call site is owned.</li><li>We ensure that values which are subject to reset-reuse are owned so their reference count
accurately reflects the real amount of references.</li></ul><p>For performance we:</p><ul><li>propagate through annotations of functions that we call. That is if we call another function <code>f</code>
which has an owned parameter we ensure that the argument we are passing is owned as well. In
particular when <code>f</code> is partially applied we ensure that all arguments are owned.</li><li>When passing a parameter into a constructor we ensure it is passed as owned so we do not have
to <code>inc</code> before calling the constructor.</li></ul></div><div class="decl" id="Lean.Compiler.LCNF.inferBorrow"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/InferBorrow.lean#L303-L309">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/InferBorrow.html#Lean.Compiler.LCNF.inferBorrow"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">inferBorrow</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Compiler/LCNF/PassManager.html#Lean.Compiler.LCNF.Pass">Pass</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.inferBorrow" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div></main>
<nav class="nav"><iframe src="../../.././navbar.html" class="navframe" frameBorder="0"></iframe></nav></body></html>