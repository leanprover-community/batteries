<html lang="en"><head><meta charset="UTF-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><link rel="stylesheet" href="../../.././style.css"></link><link rel="icon" href="../../.././favicon.svg"></link><link rel="mask-icon" href="../../.././favicon.svg" color="#000000"></link><link rel="prefetch" href="../../.././/declarations/declaration-data.bmp" as="image"></link><title>Lean.Compiler.LCNF.JoinPoints</title><script defer="true" src="../../.././mathjax-config.js"></script><script defer="true" src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script defer="true" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>const SITE_ROOT="../../.././";</script><script>const MODULE_NAME="Lean.Compiler.LCNF.JoinPoints";</script><script type="module" src="../../.././jump-src.js"></script><script type="module" src="../../.././search.js"></script><script type="module" src="../../.././expand-nav.js"></script><script type="module" src="../../.././how-about.js"></script><script type="module" src="../../.././instances.js"></script><script type="module" src="../../.././importedBy.js"></script></head><body><input id="nav_toggle" type="checkbox"></input><header><h1><label for="nav_toggle"></label><span>Documentation</span></h1><h2 class="header_filename break_within"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPoints</span></h2><form id="search_form"><input type="text" name="q" autocomplete="off"></input>&#32;<button id="search_button" onclick="javascript: form.action='../../.././search.html';">Search</button></form></header><nav class="internal_nav"><p><a href="#top">return to top</a></p><p class="gh_nav_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean">source</a></p><div class="imports"><details><summary>Imports</summary><ul><li><a href="../../.././Lean/Compiler/LCNF/FVarUtil.html">Lean.Compiler.LCNF.FVarUtil</a></li><li><a href="../../.././Lean/Compiler/LCNF/InferType.html">Lean.Compiler.LCNF.InferType</a></li><li><a href="../../.././Lean/Compiler/LCNF/PullFunDecls.html">Lean.Compiler.LCNF.PullFunDecls</a></li><li><a href="../../.././Lean/Compiler/LCNF/ScopeM.html">Lean.Compiler.LCNF.ScopeM</a></li></ul></details><details><summary>Imported by</summary><ul id="imported-by-Lean.Compiler.LCNF.JoinPoints" class="imported-by-list"></ul></details></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">CandidateInfo</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo.default"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">instInhabitedCandidateInfo</span>.<span class="name">default</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">instInhabitedCandidateInfo</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.FindCtx"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">FindCtx</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.FindState"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">FindState</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.FindM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">FindM</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.ReplaceCtx"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">ReplaceCtx</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.ReplaceM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">ReplaceM</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.find"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">find</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointFinder.replace"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">replace</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendContext"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">ExtendContext</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendState"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">ExtendState</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">ExtendM</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.replaceFVar"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">replaceFVar</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidate"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewCandidate</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidates"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewCandidates</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.extendByIfNecessary"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">extendByIfNecessary</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.mergeJpContextIfNecessary"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">mergeJpContextIfNecessary</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.withNewFunScope"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewFunScope</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.withNewJpScope"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewJpScope</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.withNewAltScope"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewAltScope</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointContextExtender.extend"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">extend</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisCtx"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">AnalysisCtx</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisState"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">AnalysisState</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceAnalysisM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">ReduceAnalysisM</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceActionM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">ReduceActionM</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointCommonArgs.isInJpScope"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">isInJpScope</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.JoinPointCommonArgs.reduce"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">reduce</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Decl.findJoinPoints?"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">findJoinPoints?</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Decl.findJoinPoints"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">findJoinPoints</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.findJoinPoints"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">findJoinPoints</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Decl.extendJoinPointContext"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">extendJoinPointContext</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.extendJoinPointContext"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">extendJoinPointContext</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.Decl.commonJoinPointArgs"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">commonJoinPointArgs</span></a></div><div class="nav_link"><a class="break_within" href="#Lean.Compiler.LCNF.commonJoinPointArgs"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">commonJoinPointArgs</span></a></div></nav><main>
<div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L22-L35">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">CandidateInfo</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><p>Info about a join point candidate (a <code>fun</code> declaration) during the find phase.</p><ul class="structure_fields" id="Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo.mk"><li id="Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo.arity" class="structure_field"><div class="structure_field_info">arity : <a href="../../.././Init/Prelude.html#Nat">Nat</a></div><div class="structure_field_doc"><p>The arity of the candidate</p></div></li><li id="Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo.associated" class="structure_field"><div class="structure_field_info">associated : <span class="fn"><a href="../../.././Std/Data/HashSet/Basic.html#Std.HashSet">Std.HashSet</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a></span></div><div class="structure_field_doc"><p>The set of candidates that rely on this candidate to be a join point.
For a more detailed explanation see the documentation of <code><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.find">find</a></code></p></div></li></ul><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo.default"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L35-L35">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo.default"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">instInhabitedCandidateInfo</span>.<span class="name">default</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo">CandidateInfo</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo.default">Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo.default</a> <a href="../../.././Init/Prelude.html#Eq">=</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo.mk">{</a> <span class="fn">arity</span> := <a href="../../.././Init/Prelude.html#Inhabited.default">default</a>, <span class="fn">associated</span> := <a href="../../.././Init/Prelude.html#Inhabited.default">default</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo.mk">}</a></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo.default" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo"><div class="instance"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L35-L35">source</a></div><div class="attributes">@[instance_reducible]</div>
<div class="decl_header"><span class="decl_kind">instance</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">instInhabitedCandidateInfo</span></a></span><span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Init/Prelude.html#Inhabited">Inhabited</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo">CandidateInfo</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo">Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo</a> <a href="../../.././Init/Prelude.html#Eq">=</a>   <a href="../../.././Init/Prelude.html#Inhabited.mk">{</a> <span class="fn">default</span> := <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo.default">Lean.Compiler.LCNF.JoinPointFinder.instInhabitedCandidateInfo.default</a> <a href="../../.././Init/Prelude.html#Inhabited.mk">}</a></li></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.FindCtx"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L37-L52">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.FindCtx"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">FindCtx</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><ul class="structure_fields" id="Lean.Compiler.LCNF.JoinPointFinder.FindCtx.mk"><li id="Lean.Compiler.LCNF.JoinPointFinder.FindCtx.definitionDepth" class="structure_field"><div class="structure_field_info">definitionDepth : <a href="../../.././Init/Prelude.html#Nat">Nat</a></div><div class="structure_field_doc"><p>The current definition depth is defined by how many <code>fun</code> binders we are
nested in at the current point. Note that this does <em>not</em> include <code>jp</code>
binders.</p></div></li><li id="Lean.Compiler.LCNF.JoinPointFinder.FindCtx.scope" class="structure_field"><div class="structure_field_info">scope : <span class="fn"><a href="../../.././Lean/Expr.html#Lean.FVarIdMap">FVarIdMap</a> <a href="../../.././Init/Prelude.html#Nat">Nat</a></span></div><div class="structure_field_doc"><p>A map from function declarations that are currently in scope to their
definition depth.</p></div></li><li id="Lean.Compiler.LCNF.JoinPointFinder.FindCtx.currentFunction" class="structure_field"><div class="structure_field_info">currentFunction : <span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a></span></div><div class="structure_field_doc"><p>The current function binder we are inside of if any.</p></div></li></ul><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.FindCtx" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.FindState"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L54-L61">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.FindState"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">FindState</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><p>The state for the join point candidate finder.</p><ul class="structure_fields" id="Lean.Compiler.LCNF.JoinPointFinder.FindState.mk"><li id="Lean.Compiler.LCNF.JoinPointFinder.FindState.candidates" class="structure_field"><div class="structure_field_info">candidates : <span class="fn"><a href="../../.././Std/Data/HashMap/Basic.html#Std.HashMap">Std.HashMap</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.CandidateInfo">CandidateInfo</a></span></div><div class="structure_field_doc"><p>All current join point candidates accessible by their <code>FVarId</code>.</p></div></li></ul><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.FindState" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.FindM"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L64-L64">source</a></div><div class="attributes">@[reducible, inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.FindM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">FindM</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.FindM">Lean.Compiler.LCNF.JoinPointFinder.FindM</a> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Init/Prelude.html#ReaderT">ReaderT</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.FindCtx">Lean.Compiler.LCNF.JoinPointFinder.FindCtx</a>
    <span class="fn">(<a href="../../.././Init/Control/StateRef.html#StateRefT'">StateRefT'</a> <a href="../../.././Init/System/IO.html#IO.RealWorld">IO.RealWorld</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.FindState">Lean.Compiler.LCNF.JoinPointFinder.FindState</a> <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a>)</span></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.FindM" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.ReplaceCtx"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L66-L66">source</a></div><div class="attributes">@[reducible, inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.ReplaceCtx"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">ReplaceCtx</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.ReplaceCtx">Lean.Compiler.LCNF.JoinPointFinder.ReplaceCtx</a> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn"><a href="../../.././Std/Data/HashMap/Basic.html#Std.HashMap">Std.HashMap</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">Lean.FVarId</a> <a href="../../.././Init/Prelude.html#Lean.Name">Lean.Name</a></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.ReplaceCtx" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.ReplaceM"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L67-L67">source</a></div><div class="attributes">@[reducible, inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.ReplaceM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">ReplaceM</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.ReplaceM">Lean.Compiler.LCNF.JoinPointFinder.ReplaceM</a> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Init/Prelude.html#ReaderT">ReaderT</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.ReplaceCtx">Lean.Compiler.LCNF.JoinPointFinder.ReplaceCtx</a> <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.ReplaceM" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.find"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L134-L204">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.find"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">find</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">CompilerM</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.FindState">FindState</a></span></div></div><p>Find all <code>fun</code> declarations that qualify as a join point, that is:</p><ul><li>are always fully applied</li><li>are always called in tail position</li></ul><p>Where a <code>fun</code> <code>f</code> is in tail position iff it is called as follows:</p><pre><code>let res := f arg
res
</code></pre><p>The majority (if not all) tail calls will be brought into this form
by the simplifier pass.</p><p>Furthermore a <code>fun</code> disqualifies as a join point if turning it into a join
point would turn a call to it into an out of scope join point.
This can happen if we have something like:</p><pre><code>def test (b : Bool) (x y : Nat) : <a href="../../.././Init/Prelude.html#Nat">Nat</a> :=
  fun myjp x =&gt; <a href="../../.././Init/Prelude.html#Nat.add">Nat.add</a> x (Nat.add x x)
  fun f y =&gt;
    let x := <a href="../../.././Init/Prelude.html#Nat.add">Nat.add</a> y y
    myjp x
  fun f y =&gt;
    let x := <a href="../../.././Init/Prelude.html#Nat.mul">Nat.mul</a> y y
    myjp x
  cases b (f x) (g y)
</code></pre><p><code>f</code> and <code>g</code> can be detected as a join point right away, however
<code>myjp</code> can only ever be detected as a join point after we have established
this. This is because otherwise the calls to <code>myjp</code> in <code>f</code> and <code>g</code> would
produce out of scope join point jumps.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.find" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointFinder.replace"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L206-L245">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.replace"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointFinder</span>.<span class="name">replace</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">state</span> : <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointFinder.FindState">FindState</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">CompilerM</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span></span></div></div><p>Replace all join point candidate <code>fun</code> declarations with <code>jp</code> ones
and all calls to them with <code>jmp</code>s.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointFinder.replace" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.ExtendContext"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L253-L266">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendContext"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">ExtendContext</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><p>The context managed by <code><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a></code>.</p><ul class="structure_fields" id="Lean.Compiler.LCNF.JoinPointContextExtender.ExtendContext.mk"><li id="Lean.Compiler.LCNF.JoinPointContextExtender.ExtendContext.currentJp?" class="structure_field"><div class="structure_field_info">currentJp? : <span class="fn"><a href="../../.././Init/Prelude.html#Option">Option</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a></span></div><div class="structure_field_doc"><p>The <code>FVarId</code> of the current join point if we are currently inside one.</p></div></li><li id="Lean.Compiler.LCNF.JoinPointContextExtender.ExtendContext.candidates" class="structure_field"><div class="structure_field_info">candidates : <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">FVarIdSet</a></div><div class="structure_field_doc"><p>The list of valid candidates for extending the context. This will be
all <code>let</code> and <code>fun</code> declarations as well as all <code>jp</code> parameters up
until the last <code>fun</code> declaration in the tree.</p></div></li></ul><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.ExtendContext" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.ExtendState"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L268-L277">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendState"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">ExtendState</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><p>The state managed by <code><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a></code>.</p><ul class="structure_fields" id="Lean.Compiler.LCNF.JoinPointContextExtender.ExtendState.mk"><li id="Lean.Compiler.LCNF.JoinPointContextExtender.ExtendState.fvarMap" class="structure_field"><div class="structure_field_info">fvarMap : <span class="fn"><a href="../../.././Std/Data/HashMap/Basic.html#Std.HashMap">Std.HashMap</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a> <span class="fn">(<a href="../../.././Std/Data/HashMap/Basic.html#Std.HashMap">Std.HashMap</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Param">Param</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span>)</span></span></div><div class="structure_field_doc"><p>A map from join point <code>FVarId</code>s to a respective map from free variables
to <code>Param</code>s. The free variables in this map are the once that the context
of said join point will be extended by passing in the respective parameter.</p></div></li></ul><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.ExtendState" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L279-L282">source</a></div><div class="attributes">@[reducible, inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">ExtendM</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><p>The monad for the <code><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.extendJoinPointContext">extendJoinPointContext</a></code> pass.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.replaceFVar"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L284-L297">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.replaceFVar"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">replaceFVar</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">fvar</span> : <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a></span></div></div><p>Replace a free variable if necessary, that is:</p><ul><li>It is in the list of candidates</li><li>We are currently within a join point (if we are within a function there
cannot be a need to replace them since we dont extend their context)</li><li>Said join point actually has a replacement parameter registered.
otherwise just return <code>fvar</code>.</li></ul><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.replaceFVar" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidate"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L299-L309">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidate"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewCandidate</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>}</span></span>
</span><span class="decl_args">
<span class="fn">(<span class="fn">fvar</span> : <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">x</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span></div></div><p>Add a new candidate to the current scope + to the list of candidates
if we are currently within a join point. Then execute <code>x</code>.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidate" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidates"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L311-L324">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidates"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewCandidates</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>}</span></span>
</span><span class="decl_args">
<span class="fn">(<span class="fn">fvars</span> : <span class="fn"><a href="../../.././Init/Prelude.html#Array">Array</a> <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">x</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span></div></div><p>Same as <code><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidate">withNewCandidate</a></code> but with multiple <code>FVarId</code>s.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.withNewCandidates" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.extendByIfNecessary"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L326-L352">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.extendByIfNecessary"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">extendByIfNecessary</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">fvar</span> : <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><p>Extend the context of the current join point (if we are within one)
by <code>fvar</code> if necessary.
This is necessary if:</p><ul><li><code>fvar</code> is not in scope (that is, was declared outside of the current jp)</li><li>we have not already extended the context by <code>fvar</code></li><li>the list of candidates contains <code>fvar</code>. This is because if we have something
like:<pre><code>let x := ..
fun f a =&gt;
  jp j b =&gt;
    let y := x
    y
</code></pre>There is no point in extending the context of <code>j</code> by <code>x</code> because we
cannot lift a join point outside of a local function declaration.</li></ul><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.extendByIfNecessary" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.mergeJpContextIfNecessary"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L354-L372">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.mergeJpContextIfNecessary"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">mergeJpContextIfNecessary</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">jp</span> : <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <a href="../../.././Init/Prelude.html#Unit">Unit</a></span></div></div><p>Merge the extended context of two join points if necessary. That is
if we have a structure such as:</p><pre><code>jp j.1 ... =&gt;
  jp j.2 .. =&gt;
    ...
  ...
</code></pre><p>And we are just done visiting <code>j.2</code> we want to extend the context of
<code>j.1</code> by all free variables that the context of <code>j.2</code> was extended by
as well because we need to drag these variables through at the call sites
of <code>j.2</code> in <code>j.1</code>.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.mergeJpContextIfNecessary" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.withNewFunScope"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L374-L382">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.withNewFunScope"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewFunScope</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>}</span></span>
</span><span class="decl_args">
<span class="fn">(<span class="fn">x</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span></div></div><p>We call this whenever we enter a new local function. It clears both the
current join point and the list of candidates since we can't lift join
points outside of functions as explained in <code><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.mergeJpContextIfNecessary">mergeJpContextIfNecessary</a></code>.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.withNewFunScope" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.withNewJpScope"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L384-L396">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.withNewJpScope"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewJpScope</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>}</span></span>
</span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.FunDecl">FunDecl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">x</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span></div></div><p>We call this whenever we enter a new join point. It will set the current
join point and extend the list of candidates by all of the parameters of
the join point. This is so in the case of nested join points that refer
to parameters of the current one we extend the context of the nested
join points by said parameters.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.withNewJpScope" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.withNewAltScope"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L398-L407">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.withNewAltScope"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">withNewAltScope</span></a></span><span class="impl_arg"><span class="decl_args">
<span class="fn">{<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>}</span></span>
</span><span class="decl_args">
<span class="fn">(<span class="fn">alt</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Alt">Alt</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">x</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.ExtendM">ExtendM</a> <span class="fn">α</span></span></div></div><p>We call this whenever we visit a new arm of a cases statement.
It will back up the current scope (since we are doing a case split
and want to continue with other arms afterwards) and add all of the
parameters of the match arm to the list of candidates.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.withNewAltScope" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointContextExtender.extend"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L409-L470">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.extend"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointContextExtender</span>.<span class="name">extend</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">CompilerM</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span></span></div></div><p>Use all of the above functions to find free variables declared outside
of join points that said join points can be reasonably extended by. Reasonable
meaning that in case the current join point is nested within a function
declaration we will not extend it by free variables declared before the
function declaration because we cannot lift join points outside of function
declarations.</p><p>All of this is done to eliminate dependencies of join points onto their
position within the code so we can pull them out as far as possible, hopefully
enabling new inlining possibilities in the next simplifier run.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointContextExtender.extend" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisCtx"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L476-L484">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisCtx"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">AnalysisCtx</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><p>Context for <code><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceAnalysisM">ReduceAnalysisM</a></code>.</p><ul class="structure_fields" id="Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisCtx.mk"><li id="Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisCtx.jpScopes" class="structure_field"><div class="structure_field_info">jpScopes : <span class="fn"><a href="../../.././Lean/Expr.html#Lean.FVarIdMap">FVarIdMap</a> <a href="../../.././Lean/Expr.html#Lean.FVarIdSet">FVarIdSet</a></span></div><div class="structure_field_doc"><p>The variables that are in scope at the time of the definition of
the join point.</p></div></li></ul><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisCtx" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisState"><div class="structure"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L486-L494">source</a></div><div class="decl_header"><span class="decl_kind">structure</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisState"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">AnalysisState</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><p>State for <code><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceAnalysisM">ReduceAnalysisM</a></code>.</p><ul class="structure_fields" id="Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisState.mk"><li id="Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisState.jpJmpArgs" class="structure_field"><div class="structure_field_info">jpJmpArgs : <span class="fn"><a href="../../.././Lean/Expr.html#Lean.FVarIdMap">FVarIdMap</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.FVarSubst">FVarSubst</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span></span></div><div class="structure_field_doc"><p>A map, that for each join point id contains a map from all (so far)
duplicated argument ids to the respective duplicate value</p></div></li></ul><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisState" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceAnalysisM"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L496-L496">source</a></div><div class="attributes">@[reducible, inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceAnalysisM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">ReduceAnalysisM</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceAnalysisM" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceActionM"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L497-L497">source</a></div><div class="attributes">@[reducible, inline]</div>
<div class="decl_header"><span class="decl_kind">abbrev</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceActionM"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">ReduceActionM</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">α</span> : <a href="../../.././foundational_types.html">Type</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././foundational_types.html">Type</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceActionM">Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceActionM</a> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Init/Prelude.html#ReaderT">ReaderT</a> <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisState">Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisState</a> <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">Lean.Compiler.LCNF.CompilerM</a></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceActionM" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointCommonArgs.isInJpScope"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L499-L500">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.isInJpScope"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">isInJpScope</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">jp </span><span class="fn">var</span> : <a href="../../.././Lean/Expr.html#Lean.FVarId">FVarId</a>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.ReduceAnalysisM">ReduceAnalysisM</a> <a href="../../.././Init/Prelude.html#Bool">Bool</a></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.isInJpScope">Lean.Compiler.LCNF.JoinPointCommonArgs.isInJpScope</a> <span class="fn">jp</span> <span class="fn">var</span></span> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn">do
  let <span class="fn">__do_lift</span> ← <a href="../../.././Init/Prelude.html#MonadReader.read">read</a>
  <span class="fn"><a href="../../.././Init/Prelude.html#Pure.pure">pure</a> <span class="fn">(<a href="../../.././Std/Data/TreeSet/Basic.html#Std.TreeSet.contains">Std.TreeSet.contains</a> <span class="fn">(<a href="../../.././Std/Data/TreeMap/Basic.html#Std.TreeMap.get!">Std.TreeMap.get!</a> <span class="fn"><span class="fn">__do_lift</span>.<a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.AnalysisCtx.jpScopes">jpScopes</a></span> <span class="fn">jp</span>)</span> <span class="fn">var</span>)</span></span></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointCommonArgs.isInJpScope" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.JoinPointCommonArgs.reduce"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L504-L629">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.reduce"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">JoinPointCommonArgs</span>.<span class="name">reduce</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">CompilerM</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span></span></div></div><p>Take a look at each join point and each of their call sites. If all
call sites of a join point have one or more arguments in common, for example:</p><pre><code>jp _jp.1 a b c =&gt; ...
...
cases foo
| n1 =&gt; jmp _jp.1 d e f
| n2 =&gt; jmp _jp.1 g e h
</code></pre><p>We can get rid of the common argument in favour of inlining it directly
into the join point (in this case the <code>e</code>). This reduces the amount of
arguments we have to pass around drastically for example in <code><a href="../../.././Init/Prelude.html#ReaderT">ReaderT</a></code> based
monad stacks.</p><p>Note 1: This transformation can in certain niche cases obtain better results.
For example:</p><pre><code>jp foo a b =&gt; ..
let x := ...
cases discr
| n1 =&gt; jmp foo x y
| n2 =&gt; jmp foo x z
</code></pre><p>Here we will not collapse the <code>x</code> since it is defined after the join point <code>foo</code>
and thus not accessible for substitution yet. We could however reorder the code in
such a way that this is possible, this is currently not done since we observe
than in praxis most of the applications of this transformation can occur naturally
without reordering.</p><p>Note 2: This transformation is kind of the opposite of <code>JoinPointContextExtender</code>.
However we still benefit from the extender because in the <code>simp</code> run after it
we might be able to pull join point declarations further up in the hierarchy
of nested functions/join points which in turn might enable additional optimizations.
After we have performed all of these optimizations we can take away the
(remaining) common arguments and end up with nicely floated and optimized
code that has as little arguments as possible in the join points.</p><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.JoinPointCommonArgs.reduce" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Decl.findJoinPoints?"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L633-L639">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.findJoinPoints?"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">findJoinPoints?</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">CompilerM</a> <span class="fn">(<a href="../../.././Init/Prelude.html#Option">Option</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span>)</span></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.Decl.findJoinPoints?" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Decl.findJoinPoints"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L641-L646">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.findJoinPoints"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">findJoinPoints</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">CompilerM</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span></span></div></div><p>Find all <code>fun</code> declarations in <code>decl</code> that qualify as join points then replace
their definitions and call sites with <code>jp</code>/<code>jmp</code>.</p><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn">decl</span>.<a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.findJoinPoints">findJoinPoints</a></span> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn">do
  let <span class="fn">__do_lift</span> ← <span class="fn"><span class="fn">decl</span>.<a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.findJoinPoints?">findJoinPoints?</a></span>
  <span class="fn"><a href="../../.././Init/Prelude.html#Pure.pure">pure</a> <span class="fn">(<span class="fn"><span class="fn">__do_lift</span>.<a href="../../.././Init/Prelude.html#Option.getD">getD</a></span> <span class="fn">decl</span>)</span></span></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.Decl.findJoinPoints" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.findJoinPoints"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L648-L649">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.findJoinPoints"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">findJoinPoints</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">occurrence</span> : <a href="../../.././Init/Prelude.html#Nat">Nat</a> := <span class="fn">0</span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Compiler/LCNF/PassManager.html#Lean.Compiler.LCNF.Pass">Pass</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.findJoinPoints">Lean.Compiler.LCNF.findJoinPoints</a> <span class="fn">occurrence</span></span> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Lean/Compiler/LCNF/PassManager.html#Lean.Compiler.LCNF.Pass.mkPerDeclaration">Lean.Compiler.LCNF.Pass.mkPerDeclaration</a> <span class="fn">`findJoinPoints</span> <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.Phase.base">Lean.Compiler.LCNF.Phase.base</a>
    <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.findJoinPoints">Lean.Compiler.LCNF.Decl.findJoinPoints</a> <span class="fn">occurrence</span></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.findJoinPoints" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Decl.extendJoinPointContext"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L654-L655">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.extendJoinPointContext"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">extendJoinPointContext</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">CompilerM</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn">decl</span>.<a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.extendJoinPointContext">extendJoinPointContext</a></span> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointContextExtender.extend">Lean.Compiler.LCNF.JoinPointContextExtender.extend</a> <span class="fn">decl</span></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.Decl.extendJoinPointContext" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.extendJoinPointContext"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L658-L660">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.extendJoinPointContext"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">extendJoinPointContext</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">occurrence</span> : <a href="../../.././Init/Prelude.html#Nat">Nat</a> := <span class="fn">0</span>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">phase</span> : <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.Phase">Phase</a> := <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.Phase.mono">Phase.mono</a>)</span></span>
<span class="decl_args">
<span class="fn">(<span class="fn">_h</span> : <span class="fn">phase</span> <a href="../../.././Init/Core.html#Ne">≠</a> <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.Phase.base">Phase.base</a> := by simp)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Compiler/LCNF/PassManager.html#Lean.Compiler.LCNF.Pass">Pass</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation">One or more equations did not get rendered due to their size.</li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.extendJoinPointContext" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.Decl.commonJoinPointArgs"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L665-L666">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.commonJoinPointArgs"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">Decl</span>.<span class="name">commonJoinPointArgs</span></a></span><span class="decl_args">
<span class="fn">(<span class="fn">decl</span> : <span class="fn"><a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a></span>)</span></span>
<span class="decl_args"> :</span><div class="decl_type"><span class="fn"><a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.CompilerM">CompilerM</a> <span class="fn">(<a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Decl">Decl</a> <a href="../../.././Lean/Compiler/LCNF/Basic.html#Lean.Compiler.LCNF.Purity.pure">Purity.pure</a>)</span></span></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><span class="fn"><span class="fn">decl</span>.<a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.commonJoinPointArgs">commonJoinPointArgs</a></span> <a href="../../.././Init/Prelude.html#Eq">=</a> <span class="fn"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.JoinPointCommonArgs.reduce">Lean.Compiler.LCNF.JoinPointCommonArgs.reduce</a> <span class="fn">decl</span></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.Decl.commonJoinPointArgs" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div><div class="decl" id="Lean.Compiler.LCNF.commonJoinPointArgs"><div class="def"><div class="gh_link"><a href="https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Compiler/LCNF/JoinPoints.lean#L669-L670">source</a></div><div class="decl_header"><span class="decl_kind">def</span>
<span class="decl_name"><a class="break_within" href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.commonJoinPointArgs"><span class="name">Lean</span>.<span class="name">Compiler</span>.<span class="name">LCNF</span>.<span class="name">commonJoinPointArgs</span></a></span><span class="decl_args"> :</span><div class="decl_type"><a href="../../.././Lean/Compiler/LCNF/PassManager.html#Lean.Compiler.LCNF.Pass">Pass</a></div></div><details><summary>Equations</summary><ul class="equations"><li class="equation"><a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.commonJoinPointArgs">Lean.Compiler.LCNF.commonJoinPointArgs</a> <a href="../../.././Init/Prelude.html#Eq">=</a>   <span class="fn"><a href="../../.././Lean/Compiler/LCNF/PassManager.html#Lean.Compiler.LCNF.Pass.mkPerDeclaration">Lean.Compiler.LCNF.Pass.mkPerDeclaration</a> <span class="fn">`commonJoinPointArgs</span> <a href="../../.././Lean/Compiler/LCNF/CompilerM.html#Lean.Compiler.LCNF.Phase.mono">Lean.Compiler.LCNF.Phase.mono</a>
    <a href="../../.././Lean/Compiler/LCNF/JoinPoints.html#Lean.Compiler.LCNF.Decl.commonJoinPointArgs">Lean.Compiler.LCNF.Decl.commonJoinPointArgs</a></span></li></ul></details><details id="instances-for-list-Lean.Compiler.LCNF.commonJoinPointArgs" class="instances-for-list"><summary>Instances For</summary><ul class="instances-for-enum"></ul></details></div></div></main>
<nav class="nav"><iframe src="../../.././navbar.html" class="navframe" frameBorder="0"></iframe></nav></body></html>